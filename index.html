<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>{{ user.username }}</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%23FF6347' /><text x='16' y='20' font-family='Arial' font-size='16' text-anchor='middle' fill='white'>P</text></svg>">
  
  <!-- External Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  
  <!-- Custom Styles -->
  <style>
    /* Base Styles */
    * {
      box-sizing: border-box;
      font-family: 'Vazirmatn', sans-serif;
    }
    
    body {
      transition: background-color 0.5s ease, color 0.3s ease;
      min-height: 100vh;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    /* Theme Colors */
    body[data-theme="light"] {
      background: #f9fafb;
      color: #111827;
      --primary-color: #3b82f6;
      --secondary-color: #6366f1;
      --accent-color: #4f46e5;
    }
    
    body[data-theme="dark"] {
      background: #1e293b;
      color: white;
      --primary-color: #6366f1;
      --secondary-color: #8b5cf6;
      --accent-color: #7c3aed;
    }
    
    body[data-theme="red"] {
      background: #1f2937;
      color: #f9fafb;
      --primary-color: #ef4444;
      --secondary-color: #dc2626;
      --accent-color: #b91c1c;
    }
    
    body[data-theme="green"] {
      background: #064e3b;
      color: #ecfdf5;
      --primary-color: #10b981;
      --secondary-color: #059669;
      --accent-color: #047857;
    }
    
    body[data-theme="purple"] {
      background: #1e1b4b;
      color: #f5f3ff;
      --primary-color: #8b5cf6;
      --secondary-color: #7c3aed;
      --accent-color: #6d28d9;
    }
    
    body[data-theme="pink"] {
      background: #500724;
      color: #fdf2f8;
      --primary-color: #ec4899;
      --secondary-color: #db2777;
      --accent-color: #be185d;
    }
    
    /* Card Styles */
    .glass-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      border-radius: 1.25rem;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      position: relative;
      padding: 1.5rem;
    }
    
    body[data-theme="light"] .glass-card {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      color: #111827;
    }
    
    body[data-theme="dark"] .glass-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    /* Glow Effects */
    .glow-icon {
      filter: drop-shadow(0 0 8px currentColor);
      transition: filter 0.3s ease;
    }
    
    .glow-icon:hover {
      filter: drop-shadow(0 0 12px currentColor);
    }
    
    /* Buttons */
    .btn-primary {
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 300px;
      text-align: center;
      margin: 0 auto;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    
    /* Proxy Actions */
    .proxy-actions button {
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      color: #86efac;
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.4));
      cursor: pointer;
      width: 36px;
      height: 36px;
    }
    
    .proxy-actions button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #f0fdf4;
      transform: translateY(-2px);
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
    }
    
    /* Badges */
    .badge {
      border-radius: 9999px;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
    }
    
    /* Proxy Items */
    .proxy-item {
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    body[data-theme="light"] .proxy-item {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .proxy-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }
    
    body[data-theme="light"] .proxy-item:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    
    /* Collapsible Sections */
    .section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-out, opacity 0.3s ease;
      opacity: 0;
    }
    
    .section-content.active {
      max-height: 2000px;
      opacity: 1;
    }
    
    .chevron.rotate {
      transform: rotate(180deg);
    }
    
    /* QR Modal */
    .qr-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      backdrop-filter: blur(8px);
    }
    
    .qr-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .qr-container {
      background: white;
      padding: 1.5rem;
      border-radius: 1.25rem;
      text-align: center;
      max-width: 90%;
      width: 360px;
      position: relative;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* App Cards */
    .app-card {
      border-radius: 1rem;
      padding: 1.25rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .app-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    
    body[data-theme="light"] .app-card {
      background: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    /* Animations */
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .animate-float {
      animation: float 5s ease-in-out infinite;
    }
    
    .animate-pulse {
      animation: pulse 1.8s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .animate-spin-slow {
      animation: spin 4s linear infinite;
    }
    
    /* Logo Animation */
    .logo-animation {
      transition: all 0.4s ease;
      transform: scale(1);
    }
    
    .logo-animation:hover {
      transform: scale(1.1) rotate(4deg);
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }
    
    /* Floating Particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      opacity: 0.4;
    }
    
    .particle {
      position: absolute;
      background-color: var(--primary-color);
      border-radius: 50%;
      opacity: 0.6;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 640px) {
      .glass-card {
        padding: 1rem;
      }
      
      .app-card {
        padding: 1rem;
      }
      
      .proxy-item {
        padding: 0.75rem;
      }
      
      .btn-primary {
        padding: 0.6rem 0.8rem;
        max-width: 100%;
        font-size: 0.875rem;
      }
      
      .proxy-actions button {
        width: 32px;
        height: 32px;
      }
      
      .qr-container {
        width: 90%;
        padding: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .btn-primary {
        padding: 0.5rem 0.7rem;
        font-size: 0.8rem;
      }
      
      .proxy-actions button {
        width: 30px;
        height: 30px;
      }
    }
  </style>
</head>

<body data-theme="dark" class="relative overflow-x-hidden">
  <!-- Background Particles -->
  <div class="particles" id="particles"></div>
  
  <!-- Main Container -->
  <div class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- User Profile Card -->
    <div id="card" class="glass-card mb-6 rounded-xl shadow-xl transition-all duration-500">
      <!-- User Header -->
      <div class="glass-card p-4 rounded-xl shadow-md mb-6 bg-gradient-to-r from-primary/40 to-secondary/40">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div class="flex items-center gap-4">
            <div class="logo-animation">
              <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/React-icon.svg/1280px-React-icon.svg.png" 
                   class="w-12 h-12 rounded-lg glow-icon" 
                   alt="Logo">
            </div>
            <div class="flex items-center gap-2">
              <span id="username" class="text-xl font-bold text-white">{{ user.username }}</span>
              <button onclick="copyUsername()" class="btn-primary bg-gray-600 hover:bg-gray-700 p-2 rounded-full">
                <i class="fas fa-copy text-sm"></i>
              </button>
            </div>
          </div>
          
          <div class="flex items-center gap-2">
            <i class="fas fa-shield-alt text-2xl glow-icon animate-pulse"></i>
            <h3 class="text-base font-bold text-white" data-i18n="user_panel">پنل کاربری</h3>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in">
        <!-- Subscription Info -->
        <div class="glass-card stat-card p-4 rounded-xl bg-gradient-to-br from-gray-800/30 to-indigo-800/30 shadow-lg">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold text-white" data-i18n="subscription_info">اطلاعات اشتراک</h3>
            <i class="fas fa-calendar-alt text-2xl glow-icon animate-pulse"></i>
          </div>
          
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="font-semibold text-sm" data-i18n="used_data">حجم استفاده‌شده:</span>
              <span class="font-medium text-sm">{{ user.used_traffic | bytesformat }}</span>
            </div>
            
            <div class="flex justify-between items-center">
              <span class="font-semibold text-sm" data-i18n="time_remaining">زمان باقی‌مانده:</span>
              {% if user.status == 'expired' %}
                <span class="badge bg-red-500 text-white text-xs" data-i18n="subscription_expired">اشتراک منقضی شده</span>
              {% else %}
                {% if user.expire %}
                  <span id="expirationValue" class="text-sm"></span>
                {% else %}
                  <span class="badge bg-green-500 text-white text-xs" data-i18n="unlimited">نامحدود</span>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>

        <!-- User Info -->
        <div class="glass-card stat-card p-4 rounded-xl bg-gradient-to-br from-gray-800/30 to-indigo-800/30 shadow-lg">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold text-white" data-i18n="user_info">اطلاعات کاربر</h3>
            <i class="fas fa-user-cog text-2xl glow-icon animate-pulse"></i>
          </div>
          
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="font-semibold text-sm" data-i18n="status">وضعیت:</span>
              {% if user.status == 'active' %}
                <span class="badge bg-green-500 text-white text-xs" data-i18n="active">فعال</span>
              {% elif user.status == 'limited' %}
                <span class="badge bg-yellow-500 text-white text-xs" data-i18n="limited">محدود</span>
              {% elif user.status == 'expired' %}
                <span class="badge bg-red-500 text-white text-xs" data-i18n="expired">منقضی شده</span>
              {% elif user.status == 'disabled' %}
                <span class="badge bg-gray-500 text-white text-xs" data-i18n="disabled">غیرفعال</span>
              {% else %}
                <span class="badge bg-gray-400 text-white text-xs" data-i18n="unknown">نامشخص</span>
              {% endif %}
            </div>
            
            <div class="flex justify-between items-center">
              <span class="font-semibold text-sm" data-i18n="expire_date">تاریخ انقضا:</span>
              <span id="statusExpireDate" class="text-sm"></span>
            </div>
            
            <div class="flex justify-between items-center">
              <span class="font-semibold text-sm" data-i18n="total_data_label">حجم کل:</span>
              {% if user.data_limit %}
                <span class="text-sm">{{ user.data_limit | bytesformat }}</span>
              {% else %}
                <span class="badge bg-green-500 text-white text-xs" data-i18n="unlimited">نامحدود</span>
              {% endif %}
            </div>
            
            <div class="flex justify-between items-center">
              <span class="font-semibold text-sm" data-i18n="last_connection">آخرین اتصال:</span>
              <span id="last-online" class="text-sm"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Servers Section -->
    <div class="glass-card mb-6 rounded-xl">
      <div class="flex justify-between items-center cursor-pointer p-4" onclick="toggleSection('servers')">
        <div class="flex items-center gap-3">
          <i class="fas fa-server text-xl text-indigo-400 glow-icon"></i>
          <h3 class="text-lg font-bold" data-i18n="servers">سرورها</h3>
        </div>
        <i class="fas fa-chevron-down chevron transition-transform" id="serversChevron"></i>
      </div>
      
      <div class="section-content mt-3" id="serversContent">
        <div class="flex flex-col gap-3 px-4" id="proxyList"></div>
      </div>
    </div>
    
    <!-- Apps Section -->
    <div class="glass-card rounded-xl">
      <div class="flex justify-between items-center cursor-pointer p-4" onclick="toggleSection('applications')">
        <div class="flex items-center gap-3">
          <i class="fas fa-box-open text-xl text-blue-400 glow-icon"></i>
          <h3 class="text-lg font-bold" data-i18n="required_apps">برنامه‌های مورد نیاز</h3>
        </div>
        <i class="fas fa-chevron-down chevron transition-transform" id="applicationsChevron"></i>
      </div>
      
      <div class="section-content mt-3 space-y-4" id="applicationsContent">
        <!-- Android -->
        <div>
          <div class="flex justify-between items-center cursor-pointer p-3 rounded-lg hover:bg-gray-700/30 transition-colors" onclick="toggleSection('android')">
            <div class="flex items-center gap-3">
              <i class="fab fa-android text-xl text-green-400 glow-icon"></i>
              <h4 class="text-base font-semibold" data-i18n="android">اندروید</h4>
            </div>
            <i class="fas fa-chevron-down chevron transition-transform" id="androidChevron"></i>
          </div>
          
          <div class="section-content px-2" id="androidContent">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-3">
              <!-- Hiddify -->
              <div class="app-card">
                <div class="flex items-center gap-3 mb-3">
                  <div class="logo-animation">
                    <img src="https://avatars.githubusercontent.com/u/126981719?s=48&v=4" 
                         class="w-10 h-10 rounded-lg" 
                         alt="Hiddify">
                  </div>
                  <span class="text-base font-bold" data-i18n="hiddify">Hiddify</span>
                </div>
                <p class="text-xs mb-3" data-i18n="hiddify_desc">کلاینت متن‌باز برای V2Ray با UI ساده.</p>
                <div class="flex justify-center">
                  <a href="https://play.google.com/store/apps/details?id=app.hiddify.com" 
                     target="_blank" 
                     class="btn-primary bg-green-500 hover:bg-green-600">
                    <i class="fab fa-android mr-1"></i>
                    <span data-i18n="download_from_playstore">دانلود</span>
                  </a>
                </div>
              </div>
              
              <!-- v2rayNG -->
              <div class="app-card">
                <div class="flex items-center gap-3 mb-3">
                  <div class="logo-animation">
                    <img src="https://www.svgrepo.com/show/505046/v2rayng.svg" 
                         class="w-10 h-10 rounded-lg" 
                         alt="v2rayNG">
                  </div>
                  <span class="text-base font-bold" data-i18n="v2rayng_git">v2rayNG</span>
                </div>
                <p class="text-xs mb-3" data-i18n="v2rayng_git_desc">کلاینت V2Ray با پشتیبانی از VMess و VLESS.</p>
                <div class="flex justify-center">
                  <a href="https://github.com/2dust/v2rayNG/releases/download/1.10.4/v2rayNG_1.10.4_universal.apk" 
                     target="_blank" 
                     class="btn-primary bg-blue-500 hover:bg-blue-600">
                    <i class="fab fa-android mr-1"></i>
                    <span>دانلود</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- iOS -->
        <div>
          <div class="flex justify-between items-center cursor-pointer p-3 rounded-lg hover:bg-gray-700/30 transition-colors" onclick="toggleSection('ios')">
            <div class="flex items-center gap-3">
              <i class="fab fa-apple text-xl glow-icon"></i>
              <h4 class="text-base font-semibold" data-i18n="ios">iOS</h4>
            </div>
            <i class="fas fa-chevron-down chevron transition-transform" id="iosChevron"></i>
          </div>
          
          <div class="section-content px-2" id="iosContent">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-3">
              <!-- Shadowrocket -->
              <div class="app-card">
                <div class="flex items-center gap-3 mb-3">
                  <div class="logo-animation">
                    <img src="https://cdn-icons-png.flaticon.com/512/731/731985.png" 
                         class="w-10 h-10 rounded-lg" 
                         alt="Shadowrocket">
                  </div>
                  <span class="text-base font-bold" data-i18n="shadowrocket">Shadowrocket</span>
                </div>
                <p class="text-xs mb-3" data-i18n="shadowrocket_desc">کلاینت قدرتمند iOS (پولی).</p>
                <div class="flex justify-center">
                  <a href="https://apps.apple.com/us/app/shadowrocket/id932747118" 
                     target="_blank" 
                     class="btn-primary bg-gray-700 hover:bg-gray-800">
                    <i class="fab fa-app-store-ios mr-1"></i>
                    <span>App Store</span>
                  </a>
                </div>
              </div>
              
              <!-- Streisand -->
              <div class="app-card">
                <div class="flex items-center gap-3 mb-3">
                  <div class="logo-animation">
                    <img src="https://cdn-icons-png.flaticon.com/512/731/731985.png" 
                         class="w-10 h-10 rounded-lg" 
                         alt="Streisand">
                  </div>
                  <span class="text-base font-bold" data-i18n="streisand">Streisand</span>
                </div>
                <p class="text-xs mb-3" data-i18n="streisand_desc">ابزار ساده برای مدیریت VPN در iOS.</p>
                <div class="flex justify-center">
                  <a href="https://apps.apple.com/us/app/streisand/id6450534064" 
                     target="_blank" 
                     class="btn-primary bg-gray-700 hover:bg-gray-800">
                    <i class="fab fa-app-store-ios mr-1"></i>
                    <span>App Store</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Windows -->
        <div>
          <div class="flex justify-between items-center cursor-pointer p-3 rounded-lg hover:bg-gray-700/30 transition-colors" onclick="toggleSection('windows')">
            <div class="flex items-center gap-3">
              <i class="fab fa-windows text-xl text-blue-300 glow-icon"></i>
              <h4 class="text-base font-semibold" data-i18n="windows">ویندوز</h4>
            </div>
            <i class="fas fa-chevron-down chevron transition-transform" id="windowsChevron"></i>
          </div>
          
          <div class="section-content px-2" id="windowsContent">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-3">
              <!-- v2rayN -->
              <div class="app-card">
                <div class="flex items-center gap-3 mb-3">
                  <div class="logo-animation">
                    <img src="https://cdn-icons-png.flaticon.com/512/888/888882.png" 
                         class="w-10 h-10 rounded-lg" 
                         alt="v2rayN">
                  </div>
                  <span class="text-base font-bold" data-i18n="v2rayn_git">v2rayN</span>
                </div>
                <p class="text-xs mb-3" data-i18n="v2rayn_git_desc">کلاینت ویندوز برای V2Ray با رابط کاربری ساده.</p>
                <div class="flex justify-center">
                  <a href="https://github.com/2dust/v2rayN/releases/latest" 
                     target="_blank" 
                     class="btn-primary bg-blue-600 hover:bg-blue-700">
                    <i class="fab fa-github mr-1"></i>
                    <span data-i18n="download">دانلود</span>
                  </a>
                </div>
              </div>
              
              <!-- Nekoray -->
              <div class="app-card">
                <div class="flex items-center gap-3 mb-3">
                  <div class="logo-animation">
                    <img src="https://cdn-icons-png.flaticon.com/512/888/888882.png" 
                         class="w-10 h-10 rounded-lg" 
                         alt="Nekoray">
                  </div>
                  <span class="text-base font-bold" data-i18n="nekoray_git">Nekoray</span>
                </div>
                <p class="text-xs mb-3" data-i18n="nekoray_git_desc">کلاینت پیشرفته برای ویندوز.</p>
                <div class="flex justify-center">
                  <a href="https://github.com/MatsuriDayo/nekoray/releases/latest" 
                     target="_blank" 
                     class="btn-primary bg-red-500 hover:bg-red-600">
                    <i class="fab fa-github mr-1"></i>
                    <span data-i18n="download">دانلود</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- QR Modal -->
  <div class="qr-modal" id="qrModal" onclick="closeQRModal()">
    <div class="qr-container" onclick="event.stopPropagation()">
      <h3 class="qr-title text-base font-semibold" data-i18n="server_qr">QR Code سرور</h3>
      <div id="qrCodeCanvas"></div>
      <button onclick="closeQRModal()" class="btn-primary bg-gray-600 hover:bg-gray-700 mt-3">
        <i class="fas fa-times mr-1"></i>
        <span data-i18n="close">بستن</span>
      </button>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg bg-gray-800 text-white hidden text-sm">
    <span id="toastMessage"></span>
  </div>

  <!-- JavaScript -->
  <script>
    // Initialize variables
    let currentLanguage = localStorage.getItem('language') || 'fa';
    let currentTheme = localStorage.getItem('theme') || 'dark';
    let userStatus = '{{ user.status }}';
    let userDataLimit = {{ user.data_limit if user.data_limit else 'null' }};
    let userExpireTimestamp = {{ user.expire if user.expire else 'null' }};
    let lastOnline = '{{ user.last_online if user.last_online else "" }}';
    
    // Create floating particles
    function createParticles() {
      const particles = document.getElementById('particles');
      particles.innerHTML = '';
      
      const particleCount = 25;
      const colors = {
        dark: ['#6366f1', '#8b5cf6', '#7c3aed', '#a855f7'],
        light: ['#3b82f6', '#6366f1', '#4f46e5', '#818cf8'],
        red: ['#ef4444', '#dc2626', '#b91c1c', '#991b1b'],
        green: ['#10b981', '#059669', '#047857', '#065f46'],
        purple: ['#8b5cf6', '#7c3aed', '#6d28d9', '#5b21b6'],
        pink: ['#ec4899', '#db2777', '#be185d', '#9d174d']
      };
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        const size = Math.random() * 4 + 2;
        const x = Math.random() * window.innerWidth;
        const y = Math.random() * window.innerHeight;
        const duration = Math.random() * 12 + 8;
        const delay = Math.random() * -15;
        const opacity = Math.random() * 0.4 + 0.2;
        
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${delay}s`;
        particle.style.opacity = opacity;
        
        const themeColors = colors[currentTheme] || colors.dark;
        const randomColor = themeColors[Math.floor(Math.random() * themeColors.length)];
        particle.style.backgroundColor = randomColor;
        
        if (Math.random() > 0.5) {
          particle.style.animationName = 'float';
          particle.style.animationTimingFunction = 'ease-in-out';
        } else {
          particle.style.animationName = 'spin';
          particle.style.animationTimingFunction = 'linear';
        }
        
        particles.appendChild(particle);
      }
    }
    
    // Translations
    const translations = {
      'total_data_label' : { 'fa': 'حجم کل', 'en': 'Total volume', 'ru': 'Общий объем' },
      'qrSubButton' : { 'fa': 'بارکد', 'en': 'barcode', 'ru': 'штрих-код' },
      'less_than_minute' : { 'fa': 'آنلاین', 'en': 'online', 'ru': 'онлайн' },
      'unlimited' : { 'fa': 'نامحدود', 'en': 'Unlimited', 'ru': 'Неограниченно' },
      'download_from_playstore' : { 'fa': 'گوگل پلی', 'en': 'Google Play', 'ru': 'Гугл Плей' },
      'subscription_info': { 'fa': 'اطلاعات اشتراک', 'en': 'Subscription Info', 'ru': 'Информация о подписке' },
      'used_data': { 'fa': 'حجم استفاده‌شده', 'en': 'Used Data', 'ru': 'Использовано данных' },
      'time_remaining': { 'fa': 'زمان باقی‌مانده', 'en': 'Time Remaining', 'ru': 'Осталось времени' },
      'subscription_expired': { 'fa': 'اشتراک منقضی شده', 'en': 'Subscription expired', 'ru': 'Подписка истекла' },
      'user_info': { 'fa': 'اطلاعات کاربر', 'en': 'User Info', 'ru': 'Информация о пользователе' },
      'status': { 'fa': 'وضعیت:', 'en': 'Status:', 'ru': 'Статус:' },
      'active': { 'fa': 'فعال', 'en': 'Active', 'ru': 'Активен' },
      'limited': { 'fa': 'محدود', 'en': 'Limited', 'ru': 'Ограничен' },
      'expired': { 'fa': 'منقضی شده', 'en': 'Expired', 'ru': 'Истек' },
      'disabled': { 'fa': 'غیرفعال', 'en': 'Disabled', 'ru': 'Отключен' },
      'unknown': { 'fa': 'نامشخص', 'en': 'Unknown', 'ru': 'Неизвестно' },
      'expire_date': { 'fa': 'تاریخ انقضا:', 'en': 'Expiration Date:', 'ru': 'Дата истечения:' },
      'last_connection': { 'fa': 'آخرین اتصال:', 'en': 'Last Connection:', 'ru': 'Последнее подключение:' },
      'required_apps': { 'fa': 'برنامه‌های مورد نیاز', 'en': 'Required Apps', 'ru': 'Необходимые приложения' },
      'android': { 'fa': 'اندروید', 'en': 'Android', 'ru': 'Android' },
      'hiddify': { 'fa': 'Hiddify', 'en': 'Hiddify', 'ru': 'Hiddify' },
      'hiddify_desc': { 'fa': 'کلاینت متن‌باز و قدرتمند برای پروتکل‌های V2Ray با رابط کاربری ساده.', 'en': 'Powerful open-source client for V2Ray protocols with a simple interface.', 'ru': 'Мощный клиент с открытым исходным кодом для протоколов V2Ray с простым интерфейсом.' },
      'v2rayng_git': { 'fa': 'v2rayNG GIT', 'en': 'v2rayNG GIT', 'ru': 'v2rayNG GIT' },
      'v2rayng_git_desc': { 'fa': 'کلاینت متن‌باز برای پروتکل‌های V2Ray با پشتیبانی از VMess، VLESS و Shadowsocks.', 'en': 'Open-source client for V2Ray protocols with VMess, VLESS, and Shadowsocks support.', 'ru': 'Клиент с открытым исходным кодом для протоколов V2Ray с поддержкой VMess, VLESS и Shadowsocks.' },
      'ios': { 'fa': 'iOS', 'en': 'iOS', 'ru': 'iOS' },
      'shadowrocket': { 'fa': 'Shadowrocket', 'en': 'Shadowrocket', 'ru': 'Shadowrocket' },
      'shadowrocket_desc': { 'fa': 'کلاینت قدرتمند برای iOS با پشتیبانی از پروتکل‌های متعدد (پولی).', 'en': 'Powerful iOS client with support for multiple protocols (paid).', 'ru': 'Мощный клиент для iOS с поддержкой множества протоколов (платный).' },
      'streisand': { 'fa': 'Streisand', 'en': 'Streisand', 'ru': 'Streisand' },
      'streisand_desc': { 'fa': 'ابزاری ساده برای مدیریت سرورهای VPN در iOS.', 'en': 'Simple tool for managing VPN servers on iOS.', 'ru': 'Простой инструмент для управления VPN-серверами на iOS.' },
      'windows': { 'fa': 'ویندوز', 'en': 'Windows', 'ru': 'Windows' },
      'v2rayn_git': { 'fa': 'v2rayN GIT', 'en': 'v2rayN GIT', 'ru': 'v2rayN GIT' },
      'v2rayn_git_desc': { 'fa': 'کلاینت ویندوز برای V2Ray با رابط کاربری ساده.', 'en': 'Windows client for V2Ray with a simple interface.', 'ru': 'Клиент для Windows с простым интерфейсом для V2Ray.' },
      'nekoray_git': { 'fa': 'Nekoray GIT', 'en': 'Nekoray GIT', 'ru': 'Nekoray GIT' },
      'nekoray_git_desc': { 'fa': 'کلاینت پیشرفته با پشتیبانی از پروتکل‌های متعدد.', 'en': 'Advanced client with support for multiple protocols.', 'ru': 'Продвинутый клиент с поддержкой множества протоколов.' },
      'server_qr': { 'fa': 'QR Code سرور', 'en': 'Server QR Code', 'ru': 'QR-код сервера' },
      'copy_all_servers': { 'fa': 'کپی همه سرورها', 'en': 'Copy all servers', 'ru': 'Копировать все серверы' },
      'copy_subscription_link': { 'fa': 'کپی لینک سابسکریپشن', 'en': 'Copy subscription link', 'ru': 'Копировать ссылку на подписку' },
      'copied': { 'fa': 'کپی شد!', 'en': 'Copied!', 'ru': 'Скопировано!' },
      'close': { 'fa': 'بستن', 'en': 'Close', 'ru': 'Закрыть' },
      'error_copy': { 'fa': 'خطا در کپی کردن!', 'en': 'Copy failed!', 'ru': 'Ошибка копирования!' }
    };
    
    // Toggle section visibility
    function toggleSection(section) {
      const content = document.getElementById(section + 'Content');
      const chevron = document.getElementById(section + 'Chevron');
      if (content && chevron) {
        content.classList.toggle('active');
        chevron.classList.toggle('rotate');
      }
    }
    
    // Copy username function
    function copyUsername() {
      const usernameText = document.getElementById("username").innerText;
      copyToClipboard(usernameText);
    }
    
    // Show toast notification
    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      if (toast && toastMessage) {
        toastMessage.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.add('flex', 'items-center', 'justify-center');
        
        setTimeout(() => {
          toast.classList.add('hidden');
          toast.classList.remove('flex', 'items-center', 'justify-center');
        }, duration);
      }
    }
    
    // Copy to clipboard helper with fallback
    function copyToClipboard(text) {
      if (!text || text === 'False') {
        showToast(translations['error_copy'][currentLanguage]);
        return;
      }
      
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text)
          .then(() => showToast(translations['copied'][currentLanguage]))
          .catch(err => {
            console.error('Error copying with clipboard API:', err);
            fallbackCopyToClipboard(text);
          });
      } else {
        fallbackCopyToClipboard(text);
      }
    }
    
    // Fallback copy method
    function fallbackCopyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showToast(translations['copied'][currentLanguage]);
        } else {
          showToast(translations['error_copy'][currentLanguage]);
        }
      } catch (err) {
        console.error('Fallback copy failed:', err);
        showToast(translations['error_copy'][currentLanguage]);
      }
      
      document.body.removeChild(textarea);
    }
    
    // Copy all links
    function copyAllLinks() {
      const links = {{ user.links | tojson }};
      if (!Array.isArray(links) || links.length === 0) {
        showToast(translations['error_copy'][currentLanguage]);
        return;
      }
      
      const validLinks = links.filter(link => link && link !== 'False');
      if (validLinks.length === 0) {
        showToast(translations['error_copy'][currentLanguage]);
        return;
      }
      
      copyToClipboard(validLinks.join('\n\n'));
    }
    
    // Format date in Persian
    function toPersianDate(date) {
      const persianDate = new Date(date).toLocaleDateString('fa-IR-u-nu-latn', {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: false
      }).split(/[\s,]+/);
      
      const [year, month, day] = persianDate[0].split('/');
      const time = persianDate[1];
      return `${year}/${month}/${day} ${time}`;
    }
    
    // Get time ago string
    function getTimeAgo(dateString) {
      const pastDate = new Date(dateString + 'Z');
      const now = new Date();
      if (isNaN(pastDate)) return translations['unknown'][currentLanguage];
      
      const diffInMs = now - pastDate;
      const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
      const days = Math.floor(diffInMinutes / (60 * 24));
      const hours = Math.floor((diffInMinutes % (60 * 24)) / 60);
      const minutes = diffInMinutes % 60;
      
      let result = '';
      if (days > 0) result += `${days} روز`;
      if (hours > 0) result += (result ? ' و ' : '') + `${hours} ساعت`;
      if (minutes > 0 && days === 0)
        result += (result ? ' و ' : '') + `${minutes} دقیقه`;
      
      return result || translations['less_than_minute'][currentLanguage];
    }
    
    // Get time left until expiration
    function getTimeLeft(expireTimestamp) {
      if (!expireTimestamp) return translations['unlimited'][currentLanguage];
      const now = Math.floor(Date.now() / 1000);
      const timeLeft = expireTimestamp - now;
      if (timeLeft <= 0) return translations['subscription_expired'][currentLanguage];
      
      const days = Math.floor(timeLeft / 86400);
      const hours = Math.floor((timeLeft % 86400) / 3600);
      const minutes = Math.floor((timeLeft % 3600) / 60);
      
      let result = '';
      if (days > 0) result += `${days} روز`;
      if (hours > 0) result += (result ? ' و ' : '') + `${hours} ساعت`;
      if (minutes > 0 && days === 0) result += (result ? ' و ' : '') + `${minutes} دقیقه`;
      
      return result || translations['less_than_minute'][currentLanguage];
    }
    
    // Format date/time based on language
    function formatDateTime(timestamp) {
      if (!timestamp) return translations['unlimited'][currentLanguage];
      const date = new Date(timestamp * 1000);
      return date.toLocaleDateString(currentLanguage === 'fa' ? 'fa-IR' : 'en-US') + ' ' + 
             date.toLocaleTimeString(currentLanguage === 'fa' ? 'fa-IR' : 'en-US');
    }
    
    // Format last online time
    function formatLastOnline(dateString) {
      if (!dateString) return translations['unknown'][currentLanguage];
      const date = new Date(dateString + 'Z');
      if (isNaN(date)) return translations['unknown'][currentLanguage];
      return date.toLocaleDateString(currentLanguage === 'fa' ? 'fa-IR' : 'en-US') + ' ' + 
             date.toLocaleTimeString(currentLanguage === 'fa' ? 'fa-IR' : 'en-US');
    }
    
    // Get proxy name from link
    function getProxyName(link) {
      try {
        if (link.startsWith('vmess://')) {
          const decoded = atob(link.replace('vmess://', ''));
          const config = JSON.parse(decoded);
          return config.ps || config.add || 'Unknown VMess';
        }
        const url = new URL(link);
        const name = url.hash ? url.hash.substring(1) : url.pathname.split('/').pop();
        return decodeURIComponent(name) || 'Unknown';
      } catch (e) {
        return link.split('/').pop() || 'Unknown';
      }
    }
    
    // Get random ping for demo purposes
    function getRandomPing(min = 50, max = 500) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    // Display proxy servers list
    async function displayProxies() {
      const proxyList = document.getElementById('proxyList');
      if (!proxyList) return;
      proxyList.innerHTML = '';
      
      const links = {{ user.links | tojson }};
      
      if (!Array.isArray(links) || links.length === 0) {
        const noServers = document.createElement('div');
        noServers.className = 'text-center p-3 text-gray-400 text-sm';
        noServers.textContent = 'هیچ سروری یافت نشد';
        proxyList.appendChild(noServers);
        return;
      }
      
      // Create action buttons
      const actionButtons = document.createElement('div');
      actionButtons.className = 'grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4';
      
      // Copy All Button
      const copyAllButton = document.createElement('button');
      copyAllButton.className = 'btn-primary bg-indigo-500 hover:bg-indigo-600';
      copyAllButton.innerHTML = `<i class="fas fa-copy mr-1"></i><span>${translations['copy_all_servers'][currentLanguage]}</span>`;
      copyAllButton.addEventListener('click', function() {
        copyAllLinks();
      });
      
      // Copy Subscription Button
      const copySubButton = document.createElement('button');
      copySubButton.className = 'btn-primary bg-indigo-500 hover:bg-indigo-600';
      copySubButton.innerHTML = `<i class="fas fa-link mr-1"></i><span>${translations['copy_subscription_link'][currentLanguage]}</span>`;
      copySubButton.addEventListener('click', function() {
        const subLink = "{{ user.subscription_url }}" || "";
        copyToClipboard(subLink);
      });
      
      // QR Code Button
      const qrButton = document.createElement('button');
      qrButton.className = 'btn-primary bg-indigo-500 hover:bg-indigo-600';
      qrButton.innerHTML = `<i class="fas fa-qrcode mr-1"></i><span>${translations['qrSubButton'][currentLanguage]}</span>`;
      qrButton.addEventListener('click', function() {
        const subLink = "{{ user.subscription_url }}" || "";
        if (!subLink) {
          showToast(translations['error_copy'][currentLanguage]);
          return;
        }
        showQRCode(subLink, "اشتراک");
      });
      
      actionButtons.appendChild(copyAllButton);
      actionButtons.appendChild(copySubButton);
      actionButtons.appendChild(qrButton);
      proxyList.appendChild(actionButtons);
      
      // Add each proxy server
      for (const link of links) {
        if (!link || link === 'False') continue;
        
        const name = getProxyName(link);
        const ping = getRandomPing();
        
        // Create proxy item container
        const proxyItem = document.createElement('div');
        proxyItem.className = 'proxy-item flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-lg';
        
        // Proxy info container
        const proxyInfo = document.createElement('div');
        proxyInfo.className = 'flex flex-col mb-2 sm:mb-0';
        
        // Proxy name
        const proxyName = document.createElement('span');
        proxyName.className = 'font-semibold text-sm truncate max-w-[180px]';
        proxyName.textContent = name;
        
        // Proxy ping
        const pingSpan = document.createElement('span');
        pingSpan.className = ping < 150 ? 'text-green-400' : ping < 300 ? 'text-yellow-400' : 'text-red-400';
        pingSpan.innerHTML = `<i class="fas fa-bolt mr-1 text-xs"></i> ${ping}ms`;
        
        proxyInfo.appendChild(proxyName);
        proxyInfo.appendChild(pingSpan);
        
        // Proxy actions container
        const proxyActions = document.createElement('div');
        proxyActions.className = 'proxy-actions flex gap-2 self-end sm:self-auto';
        
        // Copy button
        const copyButton = document.createElement('button');
        copyButton.innerHTML = '<i class="fas fa-copy text-xs"></i>';
        copyButton.addEventListener('click', (e) => {
          e.stopPropagation();
          copyToClipboard(link);
        });
        
        // QR button
        const qrButton = document.createElement('button');
        qrButton.innerHTML = '<i class="fas fa-qrcode text-xs"></i>';
        qrButton.addEventListener('click', (e) => {
          e.stopPropagation();
          showQRCode(link, name);
        });
        
        proxyActions.appendChild(copyButton);
        proxyActions.appendChild(qrButton);
        
        proxyItem.appendChild(proxyInfo);
        proxyItem.appendChild(proxyActions);
        proxyList.appendChild(proxyItem);
      }
    }
    
    // Show QR Code modal
    function showQRCode(link, name = "سرور") {
      const qrCodeContainer = document.getElementById('qrCodeCanvas');
      if (!qrCodeContainer) return;
      
      qrCodeContainer.innerHTML = '';
      
      const canvas = document.createElement('canvas');
      qrCodeContainer.appendChild(canvas);
      
      QRCode.toCanvas(canvas, link, {
        width: 200,
        height: 200,
        margin: 1,
        errorCorrectionLevel: 'H',
        color: {
          dark: currentTheme === 'light' ? '#1f2937' : '#f9fafb',
          light: currentTheme === 'light' ? '#f9fafb' : '#1f2937'
        }
      }, function(error) {
        if (error) {
          console.error('Error generating QR Code:', error);
          showToast('خطا در تولید QR کد');
          return;
        }
        
        canvas.style.cursor = 'pointer';
        canvas.addEventListener('click', () => {
          copyToClipboard(link);
        });
      });
      
      const modal = document.getElementById('qrModal');
      if (modal) {
        const qrTitle = modal.querySelector('.qr-title');
        if (qrTitle) {
          qrTitle.textContent = `${translations['server_qr'][currentLanguage]}: ${name}`;
        }
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }
    
    // Close QR modal
    function closeQRModal() {
      const modal = document.getElementById('qrModal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
      }
    }
    
    // Update dynamic content
    function updateDynamicContent() {
      const expireSpan = document.getElementById('statusExpireDate');
      if (expireSpan) {
        expireSpan.textContent = userExpireTimestamp ? formatDateTime(userExpireTimestamp) : translations['unlimited'][currentLanguage];
      }
      
      const lastOnlineSpan = document.getElementById('last-online');
      if (lastOnlineSpan) {
        lastOnlineSpan.textContent = formatLastOnline(lastOnline);
      }
      
      const timeLeftSpan = document.getElementById('expirationValue');
      if (timeLeftSpan) {
        timeLeftSpan.textContent = getTimeLeft(userExpireTimestamp);
      }
    }
    
    // Initialize on DOM loaded
    document.addEventListener('DOMContentLoaded', () => {
      createParticles();
      updateDynamicContent();
      displayProxies();
      setInterval(updateDynamicContent, 60000);
      
      const animateOnScroll = () => {
        const cards = document.querySelectorAll('.glass-card');
        cards.forEach(card => {
          const rect = card.getBoundingClientRect();
          if (rect.top < window.innerHeight * 0.8) {
            card.classList.add('animate-fade-in');
          }
        });
      };
      
      window.addEventListener('scroll', animateOnScroll);
      animateOnScroll();
    });
  </script>
</body>
</html>